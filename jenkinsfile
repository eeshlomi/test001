pipeline {
	agent any
	stages {
		stage('test') {
			options { retry(2) }
			steps {
				sleep(time:1,unit:"SECONDS")
				echo "Commit hash is ${GIT_COMMIT}"
				sh '''#!/bin/bash
					[ "${GIT_BRANCH}" = "origin/master" ] && exit 0
					RETVAL=`git rev-list --left-right --count origin/master... | awk '{print $1}'`
					[ "${RETVAL}" != "0" ] && \
						echo master is ahead, merging... && \
						git merge origin/master && \
						git add --all && \
						git commit -am merged-by-jenkins && \
						LOCAL_BRANCH=`echo "${GIT_BRANCH}" | awk -F'/' '{print $1}'` && \
						git push "${GIT_URL}" +refs/heads/*:refs/remotes/origin/* && \
						echo "Failing the stage for a retry after merge"
					exit $RETVAL
				'''
			}
		}
		stage('merge-to-master') {
			steps {
				sh '''#!/bin/bash
					[ "${GIT_BRANCH}" = "origin/master" ] && exit 0
					git checkout origin/master
					git merge "${GIT_BRANCH}"
					git show-ref
					git add --all
					git commit -am merged-by-jenkins
					git push "${GIT_URL}" +refs/heads/*:refs/remotes/origin/*
					exit 0
				'''
			}
		}
	}
}
